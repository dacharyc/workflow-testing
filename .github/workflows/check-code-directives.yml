name: Check Code Example Directives

on:
    pull_request:
        paths:
        - "source/**"

jobs:
    search_code_directives:
        runs-on: ubuntu-latest
        steps:
        - name: Check out code
          uses: actions/checkout@v3
          with:  
            fetch-depth: 0  # Fetch all history so we can access 'main' or the base branch.  
  
        - name: Fetch base branch  
          run: git fetch origin ${{ github.base_ref }} --depth=1 

        - name: Search for undesired directives
          run: |
            strings_to_search=('.. code-block::' '.. code::')
            errors=""  
            
            echo "Checking diff between origin/${{ github.base_ref }} and ${{ github.sha }}"      

            new_lines=$(git diff origin/${{ github.base_ref }}...${{ github.sha }} | grep '^+' | grep -v '^\+\+\+')  
            echo -e "New lines added in this PR:\n$new_lines"  
              
            for search_string in "${strings_to_search[@]}"; do
              echo "Searching for '$search_string' in new lines..."      
              if echo "$new_lines" | grep -q "$search_string"; then          
                affected_files=$(git diff origin/${{ github.base_ref }}...${{ github.sha }} --name-only -G"$search_string")  
                errors="$errors\n$affected_files"  
              fi          
            done
              
            if [ ! -z "$errors" ]; then          
              echo -e "Errors found in the following files:"      
              echo -e "$errors"      
              echo "Please replace these directives with '.. literalinclude::' or '.. io-code-block::'"      
              exit 1          
            else          
              echo "No errors found."          
            fi
